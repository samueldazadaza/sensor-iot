<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Hist√≥rico Sensor ESP32</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    .contenedor {
      display: flex;
      gap: 20px;
    }

    .grafico, .tabla {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 50%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }

    th {
      background: #1976d2;
      color: white;
    }
  </style>
</head>

<body>

<h2>Hist√≥rico Sensor ESP32</h2>

<div class="contenedor">

  <!-- GRAFICO -->
  <div class="grafico">
    <canvas id="sensorChart"></canvas>
  </div>

  <!-- TABLA -->
  <div class="tabla">
    <table>
      <thead>
        <tr>
          <th>Fecha y Hora</th>
          <th>Valor</th>
        </tr>
      </thead>
      <tbody id="tablaDatos"></tbody>
    </table>
  </div>

</div>

<script>
  // üîπ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCEvyKVl3Bhan5J_J_zTHlYdeQCug30ge4",
    databaseURL: "https://motorcycle-telemetry-4cf4c-default-rtdb.firebaseio.com"
  };


  // üîπ Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  const tabla = document.getElementById("tablaDatos");
  const ctx = document.getElementById("sensorChart").getContext("2d");

  let labels = [];
  let values = [];

  // üîπ Crear gr√°fico
  const chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [{
        label: "Valor del sensor",
        data: values,
        borderWidth: 2,
        tension: 0.3
      }]
    }
  });

  // üîπ Referencia a Firebase
  const historicoRef = database.ref("historico");

historicoRef.on("value", snapshot => {
  const data = snapshot.val();

  labels.length = 0;
  values.length = 0;
  tabla.innerHTML = "";

  if (!data) return;

  // Convertir a array y ordenar por timestamp
  const registros = Object.entries(data)
    .sort((a, b) => a[1].timestamp - b[1].timestamp)
    .slice(-30);

  registros.forEach(([key, registro]) => {
    // ---- TABLA ----
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${key.replaceAll("_", " ")}</td>
      <td>${registro.valor}</td>
    `;
    tabla.appendChild(fila);

    // ---- GRAFICO ----
    labels.push(new Date(registro.timestamp * 1000).toLocaleTimeString('es-CO', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' }));
    values.push(registro.valor);
  });

  chart.update();
});

</script>

</body>
</html>
